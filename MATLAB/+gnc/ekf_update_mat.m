function [H,U]= ekf_update_mat(m,lla,time)
Rs = lla2ecef(lla);
Rs = Rs'.*1e-3;
R = m(1:3);
V = m(4:6);

[R,V] = eci2ecef(datevec(time), R, V);

x = R(1); 
y = R(2); 
z = R(3); 
dx = V(1); 
dy = V(2); 
dz = V(3);




xs = Rs(1); 
ys = Rs(2); 
zs = Rs(3);

lat_s = lla(1)*pi/180; long_s = lla(2)*pi/180;

% MJD_UTC = Mjday(year(time), month(time), day(time), hour(time), ...
%     minute(time), second(time));
% [U,dU,~] = ECI2ECEF(MJD_UTC, [R',V']);
% Uxx = U(1,1); Uxy = U(1,2); Uxz = U(1,3); 
% Uyx = U(2,1); Uyy = U(2,2); Uyz = U(2,3); 
% Uzx = U(3,1); Uzy = U(3,2); Uzz = U(3,3);
% dUxx = dU(1,1); dUxy = dU(1,2); dUxz = dU(1,3); 
% dUyx = dU(2,1); dUyy = dU(2,2); dUyz = dU(2,3); 
% dUzx = dU(3,1); dUzy = dU(3,2); dUzz = dU(3,3);

H_ecef = [(abs(x - xs)*sign(x - xs))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 (abs(y - ys)*sign(y - ys))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         (abs(z - zs)*sign(z - zs))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2),                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                           0;
    (cos(long_s)*cos(lat_s - pi/2)*(dz*sin(lat_s - pi/2) + dx*cos(long_s)*cos(lat_s - pi/2) + dy*cos(lat_s - pi/2)*sin(long_s)) - sin(long_s)*(dy*cos(long_s) - dx*sin(long_s)) + cos(long_s)*sin(lat_s - pi/2)*(dx*cos(long_s)*sin(lat_s - pi/2) - dz*cos(lat_s - pi/2) + dy*sin(long_s)*sin(lat_s - pi/2)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2) - (abs(x - xs)*sign(x - xs)*((cos(long_s)*(y - ys) - sin(long_s)*(x - xs))*(dy*cos(long_s) - dx*sin(long_s)) + (dz*sin(lat_s - pi/2) + dx*cos(long_s)*cos(lat_s - pi/2) + dy*cos(lat_s - pi/2)*sin(long_s))*(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys)) + (dx*cos(long_s)*sin(lat_s - pi/2) - dz*cos(lat_s - pi/2) + dy*sin(long_s)*sin(lat_s - pi/2))*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys))))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(3/2), (cos(long_s)*(dy*cos(long_s) - dx*sin(long_s)) + cos(lat_s - pi/2)*sin(long_s)*(dz*sin(lat_s - pi/2) + dx*cos(long_s)*cos(lat_s - pi/2) + dy*cos(lat_s - pi/2)*sin(long_s)) + sin(long_s)*sin(lat_s - pi/2)*(dx*cos(long_s)*sin(lat_s - pi/2) - dz*cos(lat_s - pi/2) + dy*sin(long_s)*sin(lat_s - pi/2)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2) - (abs(y - ys)*sign(y - ys)*((cos(long_s)*(y - ys) - sin(long_s)*(x - xs))*(dy*cos(long_s) - dx*sin(long_s)) + (dz*sin(lat_s - pi/2) + dx*cos(long_s)*cos(lat_s - pi/2) + dy*cos(lat_s - pi/2)*sin(long_s))*(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys)) + (dx*cos(long_s)*sin(lat_s - pi/2) - dz*cos(lat_s - pi/2) + dy*sin(long_s)*sin(lat_s - pi/2))*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys))))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(3/2), (sin(lat_s - pi/2)*(dz*sin(lat_s - pi/2) + dx*cos(long_s)*cos(lat_s - pi/2) + dy*cos(lat_s - pi/2)*sin(long_s)) - cos(lat_s - pi/2)*(dx*cos(long_s)*sin(lat_s - pi/2) - dz*cos(lat_s - pi/2) + dy*sin(long_s)*sin(lat_s - pi/2)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2) - (abs(z - zs)*sign(z - zs)*((cos(long_s)*(y - ys) - sin(long_s)*(x - xs))*(dy*cos(long_s) - dx*sin(long_s)) + (dz*sin(lat_s - pi/2) + dx*cos(long_s)*cos(lat_s - pi/2) + dy*cos(lat_s - pi/2)*sin(long_s))*(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys)) + (dx*cos(long_s)*sin(lat_s - pi/2) - dz*cos(lat_s - pi/2) + dy*sin(long_s)*sin(lat_s - pi/2))*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys))))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(3/2), (cos(long_s)*sin(lat_s - pi/2)*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys)) - sin(long_s)*(cos(long_s)*(y - ys) - sin(long_s)*(x - xs)) + cos(long_s)*cos(lat_s - pi/2)*(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2), (cos(long_s)*(cos(long_s)*(y - ys) - sin(long_s)*(x - xs)) + cos(lat_s - pi/2)*sin(long_s)*(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys)) + sin(long_s)*sin(lat_s - pi/2)*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2), (sin(lat_s - pi/2)*(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys)) - cos(lat_s - pi/2)*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2);
    (180*(sin(long_s)/(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys)) + (cos(long_s)*cos(lat_s - pi/2)*(cos(long_s)*(y - ys) - sin(long_s)*(x - xs)))/(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys))^2)*(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys))^2)/(pi*((sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys))^2 + (cos(long_s)*(y - ys) - sin(long_s)*(x - xs))^2)),                                                                                                                                                                                                                                                                                                                                  -(180*(cos(long_s)/(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys)) - (cos(lat_s - pi/2)*sin(long_s)*(cos(long_s)*(y - ys) - sin(long_s)*(x - xs)))/(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys))^2)*(sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys))^2)/(pi*((sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys))^2 + (cos(long_s)*(y - ys) - sin(long_s)*(x - xs))^2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          (180*sin(lat_s - pi/2)*(cos(long_s)*(y - ys) - sin(long_s)*(x - xs)))/(pi*((sin(lat_s - pi/2)*(z - zs) + cos(long_s)*cos(lat_s - pi/2)*(x - xs) + cos(lat_s - pi/2)*sin(long_s)*(y - ys))^2 + (cos(long_s)*(y - ys) - sin(long_s)*(x - xs))^2)),                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                           0;
    -(180*((cos(long_s)*sin(lat_s - pi/2))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2) - (abs(x - xs)*sign(x - xs)*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(3/2)))/(pi*(1 - (cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys))^2/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2))^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                               -(180*((sin(long_s)*sin(lat_s - pi/2))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2) - (abs(y - ys)*sign(y - ys)*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(3/2)))/(pi*(1 - (cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys))^2/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2))^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                                      (180*(cos(lat_s - pi/2)/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(1/2) + (abs(z - zs)*sign(z - zs)*(cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys)))/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2)^(3/2)))/(pi*(1 - (cos(long_s)*sin(lat_s - pi/2)*(x - xs) - cos(lat_s - pi/2)*(z - zs) + sin(long_s)*sin(lat_s - pi/2)*(y - ys))^2/(abs(x - xs)^2 + abs(y - ys)^2 + abs(z - zs)^2))^(1/2)),                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                                                                                                               0,                                                                                                                                                                                                                                                                                                                           0];

H = nan(4,6);
% [H(1,1:3),H(1,4:6)] = ecef2eci(datevec(time), H_ecef(1,1:3), H_ecef(1,4:6));
H(1,1:3) = ecef2eci(datevec(time), H_ecef(1,1:3));
H(1,4:6) = ecef2eci(datevec(time), H_ecef(1,4:6));
H(2,1:3) = ecef2eci(datevec(time), H_ecef(2,1:3));
H(2,4:6) = ecef2eci(datevec(time), H_ecef(2,4:6));
H(3,1:3) = ecef2eci(datevec(time), H_ecef(3,1:3));
H(3,4:6) = ecef2eci(datevec(time), H_ecef(3,4:6));
H(4,1:3) = ecef2eci(datevec(time), H_ecef(4,1:3));
H(4,4:6) = ecef2eci(datevec(time), H_ecef(4,4:6));

% [H(2,1:3),H(2,4:6)] = ecef2eci(datevec(time), H_ecef(2,1:3), H_ecef(2,4:6));
% [H(3,1:3),H(3,4:6)] = ecef2eci(datevec(time), H_ecef(3,1:3), H_ecef(3,4:6));
% [H(4,1:3),H(4,4:6)] = ecef2eci(datevec(time), H_ecef(4,1:3), H_ecef(4,4:6));

U = eye(4);
function zdot = state_dyn(t,z_in)
%% constants
mu = 3.986004415e5; % km stp
J2 = 1.08263e-3; 
rE = 6378; % km
%% Preallocate:
zdot = nan(6+6^2,1);
%% states from z_in
x = z_in(1);
y = z_in(2);
z = z_in(3);
dx = z_in(4);
dy = z_in(5);
dz = z_in(6);

Phi_flat = z_in(7:end);
Phi = reshape(Phi_flat,6,6);

%% build A Matrix
A_t = [                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0, 1, 0, 0;
    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0, 0, 1, 0;
    0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           0,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       0, 0, 0, 1;
    (mu*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(3/2) + (mu*((3*J2*rE^2*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2 - (24*J2*rE^2*x^2*z^2)/(x^2 + y^2 + z^2)^4 - (4*J2*rE^2*x^2*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) - (2*mu*x*((3*J2*rE^2*x*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*x*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (3*mu*x^2*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2),                                                                                                                                                                                                                                          - (mu*((24*J2*rE^2*x*y*z^2)/(x^2 + y^2 + z^2)^4 + (4*J2*rE^2*x*y*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) - (mu*y*((3*J2*rE^2*x*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*x*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (mu*x*((3*J2*rE^2*y*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*y*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (3*mu*x*y*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2),                                                                        (mu*x*((J2*rE^2*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)) - (J2*rE^2*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (mu*z*((3*J2*rE^2*x*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*x*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (mu*((18*J2*rE^2*x*z^3)/(x^2 + y^2 + z^2)^4 - (J2*rE^2*x*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^2 - (6*J2*rE^2*x*z)/(x^2 + y^2 + z^2)^3 + (4*J2*rE^2*x*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) - (3*mu*x*z*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2), 0, 0, 0;
    - (mu*((24*J2*rE^2*x*y*z^2)/(x^2 + y^2 + z^2)^4 + (4*J2*rE^2*x*y*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) - (mu*y*((3*J2*rE^2*x*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*x*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (mu*x*((3*J2*rE^2*y*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*y*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (3*mu*x*y*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2),                                                                                                                                                                        (mu*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(3/2) + (mu*((3*J2*rE^2*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2 - (24*J2*rE^2*y^2*z^2)/(x^2 + y^2 + z^2)^4 - (4*J2*rE^2*y^2*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) - (2*mu*y*((3*J2*rE^2*y*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*y*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (3*mu*y^2*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2),                                                                        (mu*y*((J2*rE^2*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)) - (J2*rE^2*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (mu*z*((3*J2*rE^2*y*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*y*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (mu*((18*J2*rE^2*y*z^3)/(x^2 + y^2 + z^2)^4 - (J2*rE^2*y*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^2 - (6*J2*rE^2*y*z)/(x^2 + y^2 + z^2)^3 + (4*J2*rE^2*y*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) - (3*mu*y*z*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2), 0, 0, 0;
    (mu*((J2*rE^2*((12*x*z)/(x^2 + y^2 + z^2)^2 - (24*x*z^3)/(x^2 + y^2 + z^2)^3))/(2*(x^2 + y^2 + z^2)) - (6*J2*rE^2*x*z^3)/(x^2 + y^2 + z^2)^4 + (J2*rE^2*x*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^2 - (4*J2*rE^2*x*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) - (mu*z*((3*J2*rE^2*x*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*x*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) + (mu*x*((J2*rE^2*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)) - (J2*rE^2*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (3*mu*x*z*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2), (mu*((J2*rE^2*((12*y*z)/(x^2 + y^2 + z^2)^2 - (24*y*z^3)/(x^2 + y^2 + z^2)^3))/(2*(x^2 + y^2 + z^2)) - (6*J2*rE^2*y*z^3)/(x^2 + y^2 + z^2)^4 + (J2*rE^2*y*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^2 - (4*J2*rE^2*y*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) - (mu*z*((3*J2*rE^2*y*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*y*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) + (mu*y*((J2*rE^2*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)) - (J2*rE^2*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (3*mu*y*z*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2), (mu*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(3/2) + (mu*((J2*rE^2*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2 - (J2*rE^2*(6/(x^2 + y^2 + z^2) - (30*z^2)/(x^2 + y^2 + z^2)^2 + (24*z^4)/(x^2 + y^2 + z^2)^3))/(2*(x^2 + y^2 + z^2)) + (2*J2*rE^2*z*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^2 - (4*J2*rE^2*z^2*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^3))/(x^2 + y^2 + z^2)^(1/2) + (2*mu*z*((J2*rE^2*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)) - (J2*rE^2*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(3/2) - (3*mu*z^2*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(5/2), 0, 0, 0];
%% ddt Phi
Phi_dot = A_t*Phi;
Phi_dot_flat = reshape(Phi_dot,6^2,1);
%% build output

zdot(1:3) = [dx;dy;dz];
zdot(4:6) = [(mu*((3*J2*rE^2*x*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*x*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(1/2) + (mu*x*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(3/2);
    (mu*((3*J2*rE^2*y*z^2)/(x^2 + y^2 + z^2)^3 + (J2*rE^2*y*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(1/2) + (mu*y*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(3/2);
    (mu*z*((J2*((3*z^2)/(x^2 + y^2 + z^2) - 1)*rE^2)/(2*x^2 + 2*y^2 + 2*z^2) - 1))/(x^2 + y^2 + z^2)^(3/2) - (mu*((J2*rE^2*((6*z)/(x^2 + y^2 + z^2) - (6*z^3)/(x^2 + y^2 + z^2)^2))/(2*(x^2 + y^2 + z^2)) - (J2*rE^2*z*((3*z^2)/(x^2 + y^2 + z^2) - 1))/(x^2 + y^2 + z^2)^2))/(x^2 + y^2 + z^2)^(1/2)];
% from the acceleration gradient of potential energy
zdot(7:end) = Phi_dot_flat;


end